import SwiftUI

// MARK: - Transfer Marketplace (ÏáºÌïëÎ™∞ Ïä§ÌÉÄÏùº Ïù¥Ï†Å ÏãúÏû•)

struct TransferMarketplaceView: View {
    @State private var selectedPosition: PlayerPosition = .all
    @State private var selectedPriceRange: PriceRange = .all
    @State private var searchText = ""
    @State private var showingFilters = false
    
    let availablePlayers = TransferPlayer.samplePlayers
    
    var body: some View {
        NavigationView {
            VStack(spacing: 0) {
                // Í≤ÄÏÉâ Î∞è ÌïÑÌÑ∞ Î∞î
                SearchAndFilterBar(
                    searchText: $searchText,
                    selectedPosition: $selectedPosition,
                    selectedPriceRange: $selectedPriceRange,
                    showingFilters: $showingFilters
                )
                
                // Ïù¥Ï†Å ÏãúÏû• ÌÜµÍ≥Ñ
                MarketStatsView()
                
                // ÏÑ†Ïàò Í∑∏Î¶¨Îìú
                ScrollView {
                    LazyVGrid(columns: Array(repeating: GridItem(.flexible(), spacing: 12), count: 2), spacing: 16) {
                        ForEach(filteredPlayers) { player in
                            TransferPlayerCard(player: player)
                        }
                    }
                    .padding()
                }
            }
            .navigationTitle("üõí Ïù¥Ï†Å ÎßàÏºìÌîåÎ†àÏù¥Ïä§")
            .sheet(isPresented: $showingFilters) {
                TransferFiltersView(
                    selectedPosition: $selectedPosition,
                    selectedPriceRange: $selectedPriceRange
                )
            }
        }
    }
    
    private var filteredPlayers: [TransferPlayer] {
        var filtered = availablePlayers
        
        // Ìè¨ÏßÄÏÖò ÌïÑÌÑ∞
        if selectedPosition != .all {
            filtered = filtered.filter { $0.position == selectedPosition }
        }
        
        // Í∞ÄÍ≤© ÌïÑÌÑ∞
        if selectedPriceRange != .all {
            filtered = filtered.filter { selectedPriceRange.contains($0.estimatedPrice) }
        }
        
        // Í≤ÄÏÉâ ÌÖçÏä§Ìä∏ ÌïÑÌÑ∞
        if !searchText.isEmpty {
            filtered = filtered.filter { 
                $0.name.localizedCaseInsensitiveContains(searchText) ||
                $0.currentClub.localizedCaseInsensitiveContains(searchText)
            }
        }
        
        return filtered.sorted { $0.marketValue > $1.marketValue }
    }
}

struct SearchAndFilterBar: View {
    @Binding var searchText: String
    @Binding var selectedPosition: PlayerPosition
    @Binding var selectedPriceRange: PriceRange
    @Binding var showingFilters: Bool
    
    var body: some View {
        VStack(spacing: 12) {
            HStack(spacing: 12) {
                // Í≤ÄÏÉâ Î∞î
                HStack {
                    Image(systemName: "magnifyingglass")
                        .foregroundColor(.gray)
                    
                    TextField("ÏÑ†Ïàò Ïù¥Î¶Ñ ÎòêÎäî ÌåÄ Í≤ÄÏÉâ", text: $searchText)
                        .textFieldStyle(PlainTextFieldStyle())
                }
                .padding(.horizontal, 12)
                .padding(.vertical, 8)
                .background(Color.gray.opacity(0.1))
                .cornerRadius(8)
                
                // ÌïÑÌÑ∞ Î≤ÑÌäº
                Button(action: { showingFilters = true }) {
                    Image(systemName: "slider.horizontal.3")
                        .foregroundColor(.blue)
                        .padding(8)
                        .background(Color.blue.opacity(0.1))
                        .cornerRadius(8)
                }
            }
            
            // Îπ†Î•∏ ÌïÑÌÑ∞ Ïπ©Îì§
            ScrollView(.horizontal, showsIndicators: false) {
                HStack(spacing: 8) {
                    ForEach(PlayerPosition.allCases, id: \.self) { position in
                        FilterChip(
                            title: position.displayName,
                            isSelected: selectedPosition == position
                        ) {
                            selectedPosition = position
                        }
                    }
                }
                .padding(.horizontal)
            }
        }
        .padding()
        .background(Color.white)
        .shadow(color: .black.opacity(0.05), radius: 2, x: 0, y: 1)
    }
}

struct FilterChip: View {
    let title: String
    let isSelected: Bool
    let action: () -> Void
    
    var body: some View {
        Button(action: action) {
            Text(title)
                .font(.caption)
                .fontWeight(.medium)
                .foregroundColor(isSelected ? .white : .blue)
                .padding(.horizontal, 12)
                .padding(.vertical, 6)
                .background(isSelected ? Color.blue : Color.blue.opacity(0.1))
                .cornerRadius(16)
        }
    }
}

struct MarketStatsView: View {
    var body: some View {
        HStack(spacing: 20) {
            MarketStatItem(title: "Ï¥ù Ïù¥Ï†ÅÎ£å", value: "‚Ç¨2.1B", color: .green)
            MarketStatItem(title: "ÌôúÏÑ± Îîú", value: "47", color: .blue)
            MarketStatItem(title: "ÏôÑÎ£åÎêú Ïù¥Ï†Å", value: "156", color: .purple)
        }
        .padding()
        .background(Color.gray.opacity(0.05))
    }
}

struct MarketStatItem: View {
    let title: String
    let value: String
    let color: Color
    
    var body: some View {
        VStack(spacing: 4) {
            Text(value)
                .font(.headline)
                .fontWeight(.bold)
                .foregroundColor(color)
            
            Text(title)
                .font(.caption)
                .foregroundColor(.secondary)
        }
    }
}

struct TransferPlayerCard: View {
    let player: TransferPlayer
    @State private var showingDetail = false
    
    var body: some View {
        Button(action: { showingDetail = true }) {
            VStack(spacing: 12) {
                // ÏÑ†Ïàò Ïù¥ÎØ∏ÏßÄ ÌîåÎ†àÏù¥Ïä§ÌôÄÎçî
                ZStack {
                    RoundedRectangle(cornerRadius: 12)
                        .fill(LinearGradient(
                            colors: [Color.blue.opacity(0.3), Color.purple.opacity(0.3)],
                            startPoint: .topLeading,
                            endPoint: .bottomTrailing
                        ))
                        .frame(height: 120)
                    
                    VStack {
                        Text(player.name.prefix(2))
                            .font(.title)
                            .fontWeight(.bold)
                            .foregroundColor(.white)
                        
                        Text(player.position.displayName)
                            .font(.caption)
                            .foregroundColor(.white.opacity(0.8))
                    }
                }
                
                VStack(spacing: 6) {
                    // ÏÑ†Ïàò Ïù¥Î¶Ñ
                    Text(player.name)
                        .font(.subheadline)
                        .fontWeight(.bold)
                        .lineLimit(1)
                    
                    // ÌòÑÏû¨ ÌåÄ
                    Text(player.currentClub)
                        .font(.caption)
                        .foregroundColor(.secondary)
                        .lineLimit(1)
                    
                    // ÏãúÏû• Í∞ÄÏπò
                    Text("‚Ç¨\(player.marketValue)M")
                        .font(.caption)
                        .fontWeight(.bold)
                        .foregroundColor(.green)
                    
                    // Ïù¥Ï†Å ÏÉÅÌÉú
                    TransferStatusBadge(status: player.transferStatus)
                    
                    // Í¥ÄÏã¨ ÌÅ¥ÎüΩÎì§
                    if !player.interestedClubs.isEmpty {
                        ScrollView(.horizontal, showsIndicators: false) {
                            HStack(spacing: 4) {
                                ForEach(player.interestedClubs.prefix(3), id: \.self) { club in
                                    Text(club)
                                        .font(.caption2)
                                        .padding(.horizontal, 6)
                                        .padding(.vertical, 2)
                                        .background(Color.orange.opacity(0.2))
                                        .foregroundColor(.orange)
                                        .cornerRadius(4)
                                }
                            }
                        }
                    }
                }
                .padding(.horizontal, 8)
            }
            .padding()
            .background(Color.white)
            .cornerRadius(16)
            .shadow(color: .black.opacity(0.1), radius: 4, x: 0, y: 2)
        }
        .buttonStyle(PlainButtonStyle())
        .sheet(isPresented: $showingDetail) {
            PlayerDetailView(player: player)
        }
    }
}

struct TransferStatusBadge: View {
    let status: TransferStatus
    
    var body: some View {
        Text(status.displayName)
            .font(.caption2)
            .fontWeight(.medium)
            .foregroundColor(status.color)
            .padding(.horizontal, 8)
            .padding(.vertical, 3)
            .background(status.color.opacity(0.2))
            .cornerRadius(8)
    }
}

struct PlayerDetailView: View {
    let player: TransferPlayer
    @Environment(\.dismiss) private var dismiss
    
    var body: some View {
        NavigationView {
            ScrollView {
                VStack(spacing: 24) {
                    // ÏÑ†Ïàò Ìó§Îçî
                    PlayerHeaderView(player: player)
                    
                    // Ïù¥Ï†Å Ï†ïÎ≥¥
                    TransferInfoSection(player: player)
                    
                    // ÌÜµÍ≥Ñ
                    PlayerStatsSection(player: player)
                    
                    // Í¥ÄÏã¨ ÌÅ¥ÎüΩÎì§
                    InterestedClubsSection(player: player)
                    
                    // Ïï°ÏÖò Î≤ÑÌäºÎì§
                    ActionButtonsSection(player: player)
                }
                .padding()
            }
            .navigationTitle(player.name)
            .navigationTitle(player.name)
            .toolbar {
                ToolbarItem(placement: .cancellationAction) {
                    Button("Îã´Í∏∞") {
                        dismiss()
                    }
                }
            }
        }
    }
}

struct PlayerHeaderView: View {
    let player: TransferPlayer
    
    var body: some View {
        VStack(spacing: 16) {
            // ÏÑ†Ïàò Ïù¥ÎØ∏ÏßÄ
            ZStack {
                Circle()
                    .fill(LinearGradient(
                        colors: [Color.blue, Color.purple],
                        startPoint: .topLeading,
                        endPoint: .bottomTrailing
                    ))
                    .frame(width: 120, height: 120)
                
                Text(player.name.prefix(2))
                    .font(.largeTitle)
                    .fontWeight(.bold)
                    .foregroundColor(.white)
            }
            
            VStack(spacing: 8) {
                Text(player.name)
                    .font(.title2)
                    .fontWeight(.bold)
                
                Text("\(player.position.displayName) ‚Ä¢ \(player.age)ÏÑ∏")
                    .font(.subheadline)
                    .foregroundColor(.secondary)
                
                Text(player.currentClub)
                    .font(.headline)
                    .foregroundColor(.blue)
                
                HStack(spacing: 16) {
                    VStack {
                        Text("ÏãúÏû•Í∞ÄÏπò")
                            .font(.caption)
                            .foregroundColor(.secondary)
                        Text("‚Ç¨\(player.marketValue)M")
                            .font(.headline)
                            .fontWeight(.bold)
                            .foregroundColor(.green)
                    }
                    
                    VStack {
                        Text("ÏòàÏÉÅ Ïù¥Ï†ÅÎ£å")
                            .font(.caption)
                            .foregroundColor(.secondary)
                        Text("‚Ç¨\(player.estimatedPrice)M")
                            .font(.headline)
                            .fontWeight(.bold)
                            .foregroundColor(.orange)
                    }
                }
            }
        }
    }
}

struct TransferInfoSection: View {
    let player: TransferPlayer
    
    var body: some View {
        VStack(alignment: .leading, spacing: 12) {
            Text("Ïù¥Ï†Å Ï†ïÎ≥¥")
                .font(.headline)
                .fontWeight(.bold)
            
            VStack(spacing: 8) {
                TransferInfoRow(title: "Í≥ÑÏïΩ ÎßåÎ£å", value: player.contractExpiry)
                TransferInfoRow(title: "Ïù¥Ï†Å ÏÉÅÌÉú", value: player.transferStatus.displayName)
                TransferInfoRow(title: "ÏóêÏù¥Ï†ÑÌä∏", value: player.agent)
                TransferInfoRow(title: "Íµ≠Ï†Å", value: player.nationality)
            }
        }
        .padding()
        .background(Color.gray.opacity(0.05))
        .cornerRadius(12)
    }
}

struct TransferInfoRow: View {
    let title: String
    let value: String
    
    var body: some View {
        HStack {
            Text(title)
                .font(.subheadline)
                .foregroundColor(.secondary)
            Spacer()
            Text(value)
                .font(.subheadline)
                .fontWeight(.medium)
        }
    }
}

struct PlayerStatsSection: View {
    let player: TransferPlayer
    
    var body: some View {
        VStack(alignment: .leading, spacing: 12) {
            Text("ÏãúÏ¶å ÌÜµÍ≥Ñ")
                .font(.headline)
                .fontWeight(.bold)
            
            LazyVGrid(columns: Array(repeating: GridItem(.flexible()), count: 3), spacing: 12) {
                PlayerStatCard(title: "Í≤ΩÍ∏∞", value: "\(player.stats.appearances)")
                PlayerStatCard(title: "Í≥®", value: "\(player.stats.goals)")
                PlayerStatCard(title: "Ïñ¥ÏãúÏä§Ìä∏", value: "\(player.stats.assists)")
                PlayerStatCard(title: "ÌèâÏ†ê", value: String(format: "%.1f", player.stats.rating))
                PlayerStatCard(title: "Ìå®Ïä§ ÏÑ±Í≥µÎ•†", value: "\(player.stats.passAccuracy)%")
                PlayerStatCard(title: "ÌÉúÌÅ¥", value: "\(player.stats.tackles)")
            }
        }
        .padding()
        .background(Color.gray.opacity(0.05))
        .cornerRadius(12)
    }
}

struct PlayerStatCard: View {
    let title: String
    let value: String
    
    var body: some View {
        VStack(spacing: 4) {
            Text(value)
                .font(.headline)
                .fontWeight(.bold)
                .foregroundColor(.blue)
            
            Text(title)
                .font(.caption)
                .foregroundColor(.secondary)
        }
        .padding(.vertical, 8)
        .frame(maxWidth: .infinity)
        .background(Color.white)
        .cornerRadius(8)
    }
}

struct InterestedClubsSection: View {
    let player: TransferPlayer
    
    var body: some View {
        VStack(alignment: .leading, spacing: 12) {
            Text("Í¥ÄÏã¨ ÌÅ¥ÎüΩ")
                .font(.headline)
                .fontWeight(.bold)
            
            if player.interestedClubs.isEmpty {
                Text("ÌòÑÏû¨ Í¥ÄÏã¨ÏùÑ Î≥¥Ïù¥Îäî ÌÅ¥ÎüΩÏù¥ ÏóÜÏäµÎãàÎã§.")
                    .font(.subheadline)
                    .foregroundColor(.secondary)
            } else {
                LazyVGrid(columns: Array(repeating: GridItem(.flexible()), count: 2), spacing: 8) {
                    ForEach(player.interestedClubs, id: \.self) { club in
                        Text(club)
                            .font(.subheadline)
                            .fontWeight(.medium)
                            .foregroundColor(.blue)
                            .padding()
                            .frame(maxWidth: .infinity)
                            .background(Color.blue.opacity(0.1))
                            .cornerRadius(8)
                    }
                }
            }
        }
        .padding()
        .background(Color.gray.opacity(0.05))
        .cornerRadius(12)
    }
}

struct ActionButtonsSection: View {
    let player: TransferPlayer
    
    var body: some View {
        VStack(spacing: 12) {
            Button("Í¥ÄÏã¨ Î™©Î°ùÏóê Ï∂îÍ∞Ä") {
                // Í¥ÄÏã¨ Î™©Î°ù Ï∂îÍ∞Ä Î°úÏßÅ
            }
            .font(.headline)
            .foregroundColor(.white)
            .frame(maxWidth: .infinity)
            .padding()
            .background(Color.blue)
            .cornerRadius(12)
            
            HStack(spacing: 12) {
                Button("Îâ¥Ïä§ Î≥¥Í∏∞") {
                    // ÏÑ†Ïàò Í¥ÄÎ†® Îâ¥Ïä§ Î≥¥Í∏∞
                }
                .font(.subheadline)
                .foregroundColor(.blue)
                .frame(maxWidth: .infinity)
                .padding()
                .background(Color.blue.opacity(0.1))
                .cornerRadius(8)
                
                Button("ÌÜµÍ≥Ñ ÏÉÅÏÑ∏") {
                    // ÏÉÅÏÑ∏ ÌÜµÍ≥Ñ Î≥¥Í∏∞
                }
                .font(.subheadline)
                .foregroundColor(.green)
                .frame(maxWidth: .infinity)
                .padding()
                .background(Color.green.opacity(0.1))
                .cornerRadius(8)
            }
        }
    }
}

struct TransferFiltersView: View {
    @Binding var selectedPosition: PlayerPosition
    @Binding var selectedPriceRange: PriceRange
    @Environment(\.dismiss) private var dismiss
    
    var body: some View {
        NavigationView {
            VStack(alignment: .leading, spacing: 24) {
                VStack(alignment: .leading, spacing: 12) {
                    Text("Ìè¨ÏßÄÏÖò")
                        .font(.headline)
                        .fontWeight(.bold)
                    
                    LazyVGrid(columns: Array(repeating: GridItem(.flexible()), count: 3), spacing: 8) {
                        ForEach(PlayerPosition.allCases, id: \.self) { position in
                            FilterOptionButton(
                                title: position.displayName,
                                isSelected: selectedPosition == position
                            ) {
                                selectedPosition = position
                            }
                        }
                    }
                }
                
                VStack(alignment: .leading, spacing: 12) {
                    Text("Í∞ÄÍ≤©ÎåÄ")
                        .font(.headline)
                        .fontWeight(.bold)
                    
                    VStack(spacing: 8) {
                        ForEach(PriceRange.allCases, id: \.self) { range in
                            FilterOptionButton(
                                title: range.displayName,
                                isSelected: selectedPriceRange == range
                            ) {
                                selectedPriceRange = range
                            }
                        }
                    }
                }
                
                Spacer()
                
                Button("ÌïÑÌÑ∞ Ï†ÅÏö©") {
                    dismiss()
                }
                .font(.headline)
                .foregroundColor(.white)
                .frame(maxWidth: .infinity)
                .padding()
                .background(Color.blue)
                .cornerRadius(12)
            }
            .padding()
            .navigationTitle("ÌïÑÌÑ∞")
            .toolbar {
                ToolbarItem(placement: .cancellationAction) {
                    Button("Ï∑®ÏÜå") {
                        dismiss()
                    }
                }
            }
        }
    }
}

struct FilterOptionButton: View {
    let title: String
    let isSelected: Bool
    let action: () -> Void
    
    var body: some View {
        Button(action: action) {
            Text(title)
                .font(.subheadline)
                .fontWeight(.medium)
                .foregroundColor(isSelected ? .white : .primary)
                .frame(maxWidth: .infinity)
                .padding()
                .background(isSelected ? Color.blue : Color.gray.opacity(0.1))
                .cornerRadius(8)
        }
    }
}

// MARK: - Data Models

struct TransferPlayer: Identifiable {
    let id = UUID()
    let name: String
    let age: Int
    let position: PlayerPosition
    let currentClub: String
    let nationality: String
    let marketValue: Int // in millions
    let estimatedPrice: Int // in millions
    let contractExpiry: String
    let agent: String
    let transferStatus: TransferStatus
    let interestedClubs: [String]
    let stats: PlayerStats
    
    static let samplePlayers = [
        TransferPlayer(
            name: "Kylian Mbapp√©",
            age: 24,
            position: .forward,
            currentClub: "PSG",
            nationality: "ÌîÑÎûëÏä§",
            marketValue: 180,
            estimatedPrice: 150,
            contractExpiry: "2024ÎÖÑ 6Ïõî",
            agent: "Fayza Lamari",
            transferStatus: .available,
            interestedClubs: ["Real Madrid", "Liverpool"],
            stats: PlayerStats(appearances: 34, goals: 29, assists: 5, rating: 8.2, passAccuracy: 83, tackles: 12)
        ),
        TransferPlayer(
            name: "Erling Haaland",
            age: 23,
            position: .forward,
            currentClub: "Manchester City",
            nationality: "ÎÖ∏Î•¥Ïõ®Ïù¥",
            marketValue: 170,
            estimatedPrice: 200,
            contractExpiry: "2027ÎÖÑ 6Ïõî",
            agent: "Rafaela Pimenta",
            transferStatus: .notForSale,
            interestedClubs: [],
            stats: PlayerStats(appearances: 35, goals: 36, assists: 8, rating: 8.5, passAccuracy: 75, tackles: 8)
        ),
        TransferPlayer(
            name: "Jude Bellingham",
            age: 20,
            position: .midfielder,
            currentClub: "Real Madrid",
            nationality: "ÏûâÍ∏ÄÎûúÎìú",
            marketValue: 120,
            estimatedPrice: 150,
            contractExpiry: "2029ÎÖÑ 6Ïõî",
            agent: "Mark Bennett",
            transferStatus: .notForSale,
            interestedClubs: [],
            stats: PlayerStats(appearances: 32, goals: 14, assists: 12, rating: 8.1, passAccuracy: 89, tackles: 45)
        ),
        TransferPlayer(
            name: "Victor Osimhen",
            age: 25,
            position: .forward,
            currentClub: "Napoli",
            nationality: "ÎÇòÏù¥ÏßÄÎ¶¨ÏïÑ",
            marketValue: 100,
            estimatedPrice: 120,
            contractExpiry: "2026ÎÖÑ 6Ïõî",
            agent: "Roberto Calenda",
            transferStatus: .available,
            interestedClubs: ["Chelsea", "Arsenal", "PSG"],
            stats: PlayerStats(appearances: 30, goals: 26, assists: 4, rating: 7.8, passAccuracy: 72, tackles: 15)
        )
    ]
}

struct PlayerStats {
    let appearances: Int
    let goals: Int
    let assists: Int
    let rating: Double
    let passAccuracy: Int
    let tackles: Int
}

enum PlayerPosition: CaseIterable {
    case all, goalkeeper, defender, midfielder, forward
    
    var displayName: String {
        switch self {
        case .all: return "Ï†ÑÏ≤¥"
        case .goalkeeper: return "Í≥®ÌÇ§Ìçº"
        case .defender: return "ÏàòÎπÑÏàò"
        case .midfielder: return "ÎØ∏ÎìúÌïÑÎçî"
        case .forward: return "Í≥µÍ≤©Ïàò"
        }
    }
}

enum TransferStatus {
    case available, negotiating, notForSale, medical
    
    var displayName: String {
        switch self {
        case .available: return "Ïù¥Ï†Å Í∞ÄÎä•"
        case .negotiating: return "ÌòëÏÉÅ Ï§ë"
        case .notForSale: return "Ïù¥Ï†Å Î∂àÍ∞Ä"
        case .medical: return "Î©îÎîîÏª¨ ÏßÑÌñâ"
        }
    }
    
    var color: Color {
        switch self {
        case .available: return .green
        case .negotiating: return .orange
        case .notForSale: return .red
        case .medical: return .blue
        }
    }
}

enum PriceRange: CaseIterable {
    case all, under50, from50to100, from100to150, over150
    
    var displayName: String {
        switch self {
        case .all: return "Ï†ÑÏ≤¥ Í∞ÄÍ≤©ÎåÄ"
        case .under50: return "‚Ç¨50M ÎØ∏Îßå"
        case .from50to100: return "‚Ç¨50M - ‚Ç¨100M"
        case .from100to150: return "‚Ç¨100M - ‚Ç¨150M"
        case .over150: return "‚Ç¨150M Ïù¥ÏÉÅ"
        }
    }
    
    func contains(_ price: Int) -> Bool {
        switch self {
        case .all: return true
        case .under50: return price < 50
        case .from50to100: return price >= 50 && price < 100
        case .from100to150: return price >= 100 && price < 150
        case .over150: return price >= 150
        }
    }
}

#Preview {
    TransferMarketplaceView()
}