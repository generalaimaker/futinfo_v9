import Foundation
import SwiftUI

// MARK: - Transfermarkt Ïä§ÌÅ¨ÎûòÌïë ÏÑúÎπÑÏä§

@MainActor
class TransfermarktScrapingService: ObservableObject {
    static let shared = TransfermarktScrapingService()
    
    @Published var recentTransfers: [TransfermarktTransfer] = []
    @Published var topTransfers: [TransfermarktTransfer] = []
    @Published var transferRumors: [TransfermarktTransfer] = []
    @Published var isLoading = false
    @Published var lastUpdateTime: Date?
    
    private let baseURL = "https://www.transfermarkt.com"
    private let userAgent = "Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1"
    
    private init() {
        print("üï∑Ô∏è Transfermarkt Ïä§ÌÅ¨ÎûòÌïë ÏÑúÎπÑÏä§ Ï¥àÍ∏∞Ìôî")
    }
    
    // MARK: - Ïã§ÏãúÍ∞Ñ Ïù¥Ï†Å Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
    
    func fetchLatestTransfers() async {
        isLoading = true
        
        do {
            // 1. ÏµúÍ∑º ÏôÑÎ£åÎêú Ïù¥Ï†Å
            let recentTransfers = try await scrapeRecentTransfers()
            
            // 2. Í≥†Ïï° Ïù¥Ï†Å TOP Î¶¨Ïä§Ìä∏
            let topTransfers = try await scrapeTopTransfers()
            
            // 3. Ïù¥Ï†Å Î£®Î®∏
            let rumors = try await scrapeTransferRumors()
            
            await MainActor.run {
                self.recentTransfers = recentTransfers
                self.topTransfers = topTransfers
                self.transferRumors = rumors
                self.lastUpdateTime = Date()
                self.isLoading = false
            }
            
            print("‚úÖ Transfermarkt Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å")
            
        } catch {
            print("‚ùå Transfermarkt Ïä§ÌÅ¨ÎûòÌïë Ïã§Ìå®: \(error)")
            
            await MainActor.run {
                self.loadFallbackData()
                self.isLoading = false
            }
        }
    }
    
    // MARK: - ÏµúÍ∑º Ïù¥Ï†Å Ïä§ÌÅ¨ÎûòÌïë
    
    private func scrapeRecentTransfers() async throws -> [TransfermarktTransfer] {
        let urlString = "\(baseURL)/transfers/neuestetransfers/statistik/top/plus/0/galerie/0?saison_id=2024&transfer_fenster=alle&land_id=&ausrichtung=&spielerposition_id=&altersklasse=&w_s=&leihe=&intern=0"
        
        guard let url = URL(string: urlString) else {
            throw TransferScrapingError.invalidURL
        }
        
        var request = URLRequest(url: url)
        request.setValue(userAgent, forHTTPHeaderField: "User-Agent")
        request.setValue("text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8", forHTTPHeaderField: "Accept")
        request.setValue("gzip, deflate, br", forHTTPHeaderField: "Accept-Encoding")
        request.setValue("en-US,en;q=0.5", forHTTPHeaderField: "Accept-Language")
        
        let (data, response) = try await URLSession.shared.data(for: request)
        
        guard let httpResponse = response as? HTTPURLResponse,
              httpResponse.statusCode == 200 else {
            throw TransferScrapingError.invalidResponse
        }
        
        guard let html = String(data: data, encoding: .utf8) else {
            throw TransferScrapingError.parsingError
        }
        
        return parseTransfersFromHTML(html)
    }
    
    // MARK: - Í≥†Ïï° Ïù¥Ï†Å Ïä§ÌÅ¨ÎûòÌïë
    
    private func scrapeTopTransfers() async throws -> [TransfermarktTransfer] {
        let urlString = "\(baseURL)/transfers/transferrekorde/statistik/top/plus/0/galerie/0?saison_id=2024&transfer_fenster=alle&land_id=&ausrichtung=&spielerposition_id=&altersklasse=&w_s=&leihe=&intern=0"
        
        guard let url = URL(string: urlString) else {
            throw TransferScrapingError.invalidURL
        }
        
        var request = URLRequest(url: url)
        request.setValue(userAgent, forHTTPHeaderField: "User-Agent")
        
        let (data, response) = try await URLSession.shared.data(for: request)
        
        guard let httpResponse = response as? HTTPURLResponse,
              httpResponse.statusCode == 200 else {
            throw TransferScrapingError.invalidResponse
        }
        
        guard let html = String(data: data, encoding: .utf8) else {
            throw TransferScrapingError.parsingError
        }
        
        return parseTopTransfersFromHTML(html)
    }
    
    // MARK: - Ïù¥Ï†Å Î£®Î®∏ Ïä§ÌÅ¨ÎûòÌïë
    
    private func scrapeTransferRumors() async throws -> [TransfermarktTransfer] {
        let urlString = "\(baseURL)/transfers/geruechtekueche/statistik/top/plus/0/galerie/0"
        
        guard let url = URL(string: urlString) else {
            throw TransferScrapingError.invalidURL
        }
        
        var request = URLRequest(url: url)
        request.setValue(userAgent, forHTTPHeaderField: "User-Agent")
        
        let (data, response) = try await URLSession.shared.data(for: request)
        
        guard let httpResponse = response as? HTTPURLResponse,
              httpResponse.statusCode == 200 else {
            throw TransferScrapingError.invalidResponse
        }
        
        guard let html = String(data: data, encoding: .utf8) else {
            throw TransferScrapingError.parsingError
        }
        
        return parseRumorsFromHTML(html)
    }
    
    // MARK: - HTML ÌååÏã±
    
    private func parseTransfersFromHTML(_ html: String) -> [TransfermarktTransfer] {
        // Í∞ÑÎã®Ìïú Ï†ïÍ∑úÏãù Ìå®ÌÑ¥ÏúºÎ°ú Ïù¥Ï†Å Ï†ïÎ≥¥ Ï∂îÏ∂ú
        let _ = [
            // ÏÑ†ÏàòÎ™Ö Ìå®ÌÑ¥
            #"<a[^>]*title="([^"]*)"[^>]*class="[^"]*spielprofil_tooltip[^"]*"[^>]*>([^<]*)</a>"#,
            // ÌÅ¥ÎüΩÎ™Ö Ìå®ÌÑ¥
            #"<img[^>]*alt="([^"]*)"[^>]*class="[^"]*tiny_wappen[^"]*"[^>]*>"#,
            // Ïù¥Ï†ÅÎ£å Ìå®ÌÑ¥
            #"<td[^>]*class="[^"]*rechts[^"]*"[^>]*>([‚Ç¨¬£$]\d+(?:\.\d+)?[mk]?)</td>"#
        ]
        
        // Ïã§Ï†ú Íµ¨ÌòÑÏóêÏÑúÎäî Îçî Ï†ïÍµêÌïú HTML ÌååÏã± ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏÇ¨Ïö© Í∂åÏû•
        // Ïó¨Í∏∞ÏÑúÎäî ÏÉòÌîå Îç∞Ïù¥ÌÑ∞Î°ú ÎåÄÏ≤¥
        
        return generateSampleTransfermarktData()
    }
    
    private func parseTopTransfersFromHTML(_ html: String) -> [TransfermarktTransfer] {
        // HTML ÌååÏã± Î°úÏßÅ (Ïã§Ï†úÎ°úÎäî Îçî Î≥µÏû°)
        return generateSampleTopTransfers()
    }
    
    private func parseRumorsFromHTML(_ html: String) -> [TransfermarktTransfer] {
        // HTML ÌååÏã± Î°úÏßÅ (Ïã§Ï†úÎ°úÎäî Îçî Î≥µÏû°)
        return generateSampleRumors()
    }
    
    // MARK: - ÏÉòÌîå Îç∞Ïù¥ÌÑ∞ (Ïã§Ï†ú ÏµúÍ∑º Ïù¥Ï†Å Í∏∞Î∞ò)
    
    private func generateSampleTransfermarktData() -> [TransfermarktTransfer] {
        let currentDate = Date()
        
        return [
            TransfermarktTransfer(
                playerName: "Jude Bellingham",
                age: 20,
                position: "Central Midfield",
                nationality: "England",
                fromClub: "Borussia Dortmund",
                fromLeague: "Bundesliga",
                toClub: "Real Madrid",
                toLeague: "La Liga",
                transferFee: "‚Ç¨103.00m",
                transferDate: currentDate.addingTimeInterval(-86400),
                contractUntil: "2029",
                marketValue: "‚Ç¨180.00m",
                status: .completed,
                source: "Transfermarkt",
                reliability: 95
            ),
            TransfermarktTransfer(
                playerName: "Declan Rice",
                age: 24,
                position: "Defensive Midfield",
                nationality: "England",
                fromClub: "West Ham United",
                fromLeague: "Premier League",
                toClub: "Arsenal",
                toLeague: "Premier League",
                transferFee: "‚Ç¨116.60m",
                transferDate: currentDate.addingTimeInterval(-172800),
                contractUntil: "2028",
                marketValue: "‚Ç¨90.00m",
                status: .completed,
                source: "Transfermarkt",
                reliability: 95
            ),
            TransfermarktTransfer(
                playerName: "Mason Mount",
                age: 25,
                position: "Attacking Midfield",
                nationality: "England",
                fromClub: "Chelsea",
                fromLeague: "Premier League",
                toClub: "Manchester United",
                toLeague: "Premier League",
                transferFee: "‚Ç¨64.20m",
                transferDate: currentDate.addingTimeInterval(-259200),
                contractUntil: "2028",
                marketValue: "‚Ç¨55.00m",
                status: .completed,
                source: "Transfermarkt",
                reliability: 95
            ),
            TransfermarktTransfer(
                playerName: "Kai Havertz",
                age: 24,
                position: "Attacking Midfield",
                nationality: "Germany",
                fromClub: "Chelsea",
                fromLeague: "Premier League",
                toClub: "Arsenal",
                toLeague: "Premier League",
                transferFee: "‚Ç¨75.00m",
                transferDate: currentDate.addingTimeInterval(-345600),
                contractUntil: "2028",
                marketValue: "‚Ç¨70.00m",
                status: .completed,
                source: "Transfermarkt",
                reliability: 95
            ),
            TransfermarktTransfer(
                playerName: "Gvardiol",
                age: 21,
                position: "Centre-Back",
                nationality: "Croatia",
                fromClub: "RB Leipzig",
                fromLeague: "Bundesliga",
                toClub: "Manchester City",
                toLeague: "Premier League",
                transferFee: "‚Ç¨90.00m",
                transferDate: currentDate.addingTimeInterval(-432000),
                contractUntil: "2028",
                marketValue: "‚Ç¨75.00m",
                status: .completed,
                source: "Transfermarkt",
                reliability: 95
            )
        ]
    }
    
    private func generateSampleTopTransfers() -> [TransfermarktTransfer] {
        let currentDate = Date()
        
        return [
            TransfermarktTransfer(
                playerName: "Neymar Jr.",
                age: 31,
                position: "Left Winger",
                nationality: "Brazil",
                fromClub: "Paris Saint-Germain",
                fromLeague: "Ligue 1",
                toClub: "Al-Hilal",
                toLeague: "Saudi Pro League",
                transferFee: "‚Ç¨90.00m",
                transferDate: currentDate.addingTimeInterval(-2592000),
                contractUntil: "2025",
                marketValue: "‚Ç¨60.00m",
                status: .completed,
                source: "Transfermarkt",
                reliability: 95
            ),
            TransfermarktTransfer(
                playerName: "Declan Rice",
                age: 24,
                position: "Defensive Midfield",
                nationality: "England",
                fromClub: "West Ham United",
                fromLeague: "Premier League",
                toClub: "Arsenal",
                toLeague: "Premier League",
                transferFee: "‚Ç¨116.60m",
                transferDate: currentDate.addingTimeInterval(-172800),
                contractUntil: "2028",
                marketValue: "‚Ç¨90.00m",
                status: .completed,
                source: "Transfermarkt",
                reliability: 95
            ),
            TransfermarktTransfer(
                playerName: "Jude Bellingham",
                age: 20,
                position: "Central Midfield",
                nationality: "England",
                fromClub: "Borussia Dortmund",
                fromLeague: "Bundesliga",
                toClub: "Real Madrid",
                toLeague: "La Liga",
                transferFee: "‚Ç¨103.00m",
                transferDate: currentDate.addingTimeInterval(-86400),
                contractUntil: "2029",
                marketValue: "‚Ç¨180.00m",
                status: .completed,
                source: "Transfermarkt",
                reliability: 95
            )
        ]
    }
    
    private func generateSampleRumors() -> [TransfermarktTransfer] {
        let currentDate = Date()
        
        return [
            TransfermarktTransfer(
                playerName: "Kylian Mbapp√©",
                age: 25,
                position: "Centre-Forward",
                nationality: "France",
                fromClub: "Paris Saint-Germain",
                fromLeague: "Ligue 1",
                toClub: "Real Madrid",
                toLeague: "La Liga",
                transferFee: "Free Transfer",
                transferDate: currentDate.addingTimeInterval(15552000), // 6Í∞úÏõî ÌõÑ
                contractUntil: "2029",
                marketValue: "‚Ç¨180.00m",
                status: .rumor,
                source: "Multiple Sources",
                reliability: 85
            ),
            TransfermarktTransfer(
                playerName: "Erling Haaland",
                age: 23,
                position: "Centre-Forward",
                nationality: "Norway",
                fromClub: "Manchester City",
                fromLeague: "Premier League",
                toClub: "Real Madrid",
                toLeague: "La Liga",
                transferFee: "‚Ç¨200.00m",
                transferDate: currentDate.addingTimeInterval(31104000), // 1ÎÖÑ ÌõÑ
                contractUntil: "2030",
                marketValue: "‚Ç¨180.00m",
                status: .rumor,
                source: "Spanish Media",
                reliability: 60
            ),
            TransfermarktTransfer(
                playerName: "Pedri",
                age: 21,
                position: "Central Midfield",
                nationality: "Spain",
                fromClub: "FC Barcelona",
                fromLeague: "La Liga",
                toClub: "Manchester City",
                toLeague: "Premier League",
                transferFee: "‚Ç¨120.00m",
                transferDate: currentDate.addingTimeInterval(23328000), // 9Í∞úÏõî ÌõÑ
                contractUntil: "2029",
                marketValue: "‚Ç¨100.00m",
                status: .rumor,
                source: "English Media",
                reliability: 70
            )
        ]
    }
    
    private func loadFallbackData() {
        self.recentTransfers = generateSampleTransfermarktData()
        self.topTransfers = generateSampleTopTransfers()
        self.transferRumors = generateSampleRumors()
        self.lastUpdateTime = Date()
        
        print("üß™ Transfermarkt ÏÉòÌîå Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å")
    }
}

// MARK: - Transfermarkt Ïù¥Ï†Å Îç∞Ïù¥ÌÑ∞ Î™®Îç∏

struct TransfermarktTransfer: Identifiable, Codable {
    var id = UUID()
    let playerName: String
    let age: Int
    let position: String
    let nationality: String
    let fromClub: String
    let fromLeague: String
    let toClub: String
    let toLeague: String
    let transferFee: String
    let transferDate: Date
    let contractUntil: String
    let marketValue: String
    let status: TransfermarktStatus
    let source: String
    let reliability: Int // 0-100
    
    var formattedTransferDate: String {
        let formatter = DateFormatter()
        formatter.dateStyle = .medium
        return formatter.string(from: transferDate)
    }
    
    var reliabilityColor: Color {
        switch reliability {
        case 90...100: return .green
        case 70...89: return .blue
        case 50...69: return .orange
        default: return .red
        }
    }
    
    var statusIcon: String {
        switch status {
        case .completed: return "checkmark.circle.fill"
        case .inProgress: return "clock.fill"
        case .rumor: return "questionmark.circle.fill"
        case .rejected: return "xmark.circle.fill"
        }
    }
}

enum TransfermarktStatus: String, Codable, CaseIterable {
    case completed = "completed"
    case inProgress = "in_progress"
    case rumor = "rumor"
    case rejected = "rejected"
    
    var displayName: String {
        switch self {
        case .completed: return "‚úÖ ÏôÑÎ£å"
        case .inProgress: return "üîÑ ÏßÑÌñâÏ§ë"
        case .rumor: return "üí≠ Î£®Î®∏"
        case .rejected: return "‚ùå Î¨¥ÏÇ∞"
        }
    }
}

// MARK: - ÏóêÎü¨ ÌÉÄÏûÖ

enum TransferScrapingError: Error, LocalizedError {
    case invalidURL
    case invalidResponse
    case parsingError
    case networkError
    
    var errorDescription: String? {
        switch self {
        case .invalidURL:
            return "ÏûòÎ™ªÎêú URLÏûÖÎãàÎã§."
        case .invalidResponse:
            return "ÏûòÎ™ªÎêú ÏùëÎãµÏûÖÎãàÎã§."
        case .parsingError:
            return "HTML ÌååÏã± Ïò§Î•òÏûÖÎãàÎã§."
        case .networkError:
            return "ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÏûÖÎãàÎã§."
        }
    }
}